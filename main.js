// ==UserScript==
// @name         WME Wazer Creater
// @version      2021.06.12.01
// @description  Creates Wazer Comments
// @author       njs923
// @include      https://www.waze.com/editor*
// @include      https://www.waze.com/*/editor*
// @include      https://beta.waze.com/*
// @exclude      https://www.waze.com/user/editor*
// @grant        none
// @require      https://greasyfork.org/scripts/24851-wazewrap/code/WazeWrap.js
// @license      GPLv3
// @namespace    https://greasyfork.org/users/783417
// ==/UserScript==

/* global W */
/* global OpenLayers */
/* ecmaVersion 2017 */
/* global require */
/* global $ */
/* global _ */
/* global WazeWrap */
/* eslint curly: ["warn", "multi-or-nest"] */

(function() {
    /*const wazerMainPoints = [[-637.0713572809473,-484.64639748912305],[-580.9379146788269,-390.29444068763405],[-712.3140569794923,-335.95249088760465],[-841.3015421787277,-252.94665548671037],[-963.1230559786782,-128.73648458812386],[-902.8094633789733,-121.57051318790764],[-843.0930350795388,-103.05842038430274],[-798.3057137783617,-67.2285633860156],[-736.7977926786989,15.180107813328505],[-710.522564179264,105.9490788159892],[-686.0388284791261,353.7722565140575],[-645.4316572798416,540.0875129103661],[-521.2214862778783,738.3460550131276],[-388.6510153785348,850.6129403095692],[-245.3315873797983,931.8272828077897],[-61.40498807840049,983.1834112089127],[129.68758262135088,1001.0983397141099],[345.8610532209277,970.045797011815],[472.45988132152706,928.2442971104756],[632.4999092211947,818.3660690113902],[793.7342657214031,651.1600697096437],[866.5883083213121,498.28601311240345],[914.361451022327,364.5212136125192],[915.5557795204222,210.45282851345837],[880.9202511217445,34.886529210954905],[786.5682943211868,-138.29111298918724],[646.8318520216271,-278.02755528781563],[471.26555282156914,-387.6072010891512],[392.43986732140183,-340.1326407901943],[316.0028390213847,-335.35532648675144],[256.2864107210189,-347.29861218854785],[204.0345360217616,-376.5596618866548],[164.3231110200286,-412.98668338824064],[139.24221112113446,-451.20519749168307],[-225.92374807875603,-453.89243658818305],[-268.02383007854223,-401.0433974880725],[-314.60264417808503,-364.0192119870335],[-333.41331907734275,-354.16600128263235],[-365.06302607804537,-342.5212977854535],[-434.63266517873853,-335.95249058585614],[-466.2823721775785,-338.34114778600633],[-503.0079755783081,-349.0901048881933],[-566.0088074784726,-387.9057832872495],[-634.682700178586,-490.6180401938036],[-646.3274036794901,-549.7373041873798],[-634.3841179776937,-636.9232894871384],[-596.4641859764233,-700.5212856903672],[-538.240668377839,-747.1000997917727],[-484.1973006790504,-767.1051032878458],[-430.45251517836004,-777.2568960860372],[-362.3757868790999,-767.7022676886991],[-287.13308717962354,-729.4837535852566],[-241.74860167875886,-669.7673251880333],[-213.3832981782034,-609.7523145861924],[-208.30740177910775,-570.6380541874096],[112.66840052045882,-568.8465611897409],[117.74429692141712,-635.1317967828363],[179.84938242007047,-719.9291249867529],[230.01118222251534,-756.3561461865902],[295.40067122038454,-771.5838353866711],[384.0795673225075,-768.2994318883866],[439.018681419082,-750.9816677886993],[502.31809542234987,-691.2652393868193],[534.5649667214602,-633.9374681841582],[547.7025810219347,-550.0358862848952],[541.7309381216764,-481.06341168656945],[631.3055806225166,-412.98668338824064],[694.9035769216716,-380.7398118879646],[753.1270944196731,-332.96666938997805],[869.2755476208404,-208.75649828836322],[923.020333122462,-116.79319868795574],[962.4331758208573,-26.024227586574852],[1003.0403471216559,96.99161481112242],[1022.1496042208746,252.85149270948023],[1016.1779613215476,384.2276351125911],[982.7367615224794,513.2151203099638],[909.8827189225703,688.781419611536],[685.9461126206443,924.6613116106018],[553.6742238216102,1002.292668312788],[399.30725662223995,1067.3835753127933],[214.78349302057177,1101.421939412132],[-34.234013178385794,1099.0332823144272],[-222.63934457860887,1053.648796708323],[-378.2006403785199,973.6287828152999],[-522.1172326784581,873.9023475144058],[-623.0379965789616,771.1900907112285],[-694.6977105792612,676.8381339078769],[-746.0538389785215,571.7372201131657],[-778.3007102776319,440.3610777128488],[-796.2156387791038,341.8289710134268],[-801.5901172785088,240.31104281079024],[-812.9362386791036,133.41863611154258],[-828.163927978836,67.13340050913393],[-853.5434099789709,25.33190080523491],[-887.5817740783095,-6.3178062895312905],[-929.9804381784052,-20.64974908810109],[-984.9195522787049,-21.246913285925984],[-1034.7827699789777,-41.55049908813089],[-1058.6693413788453,-82.15767039079219],[-1066.133894879371,-122.1676771864295],[-1062.5509091783315,-149.6372342882678],[-1045.8303091777489,-195.02171978913248],[-978.9479094799608,-269.6672551902011],[-911.4683454791084,-329.38368358742446],[-827.2681814786047,-389.1001118896529],[-760.9829459786415,-429.11011888552457]];
    const wazerLEyePoints = [[-131.5717913787812,560.9882631106302],[-182.92791977804154,552.0307989129797],[-227.71524097863585,513.8122847126797],[-245.03300527855754,467.2334706103429],[-242.04718377813697,430.8064494114369],[-224.7294195778668,395.57375661376864],[-210.397476779297,375.2701710117981],[-196.06553397793323,360.3410639129579],[-179.9420983772725,352.57792821433395],[-155.45836267992854,350.78643541317433],[-122.61432718019933,347.8006140124053],[-94.54760577902198,357.35524251591414],[-64.6893916791305,383.03330671414733],[-50.95461317989975,400.3510709134862],[-36.025506077334285,436.18092791270465],[-34.234013178385794,463.05332071334124],[-38.414163178764284,492.91153481509537],[-50.95461317989975,521.575420412235],[-78.42417017836124,546.059156014584],[-102.90790577884763,555.0166203100234]];
    const wazerREyePoints = [[307.3439569212496,559.7939346134663],[281.6658927220851,542.4761704122648],[264.3481285199523,510.82646331284195],[257.1821571206674,482.16257770732045],[261.3623071210459,445.7355564124882],[271.51409992109984,414.68301371112466],[289.4290284207091,393.7822638088837],[318.09291402157396,373.4786781091243],[345.56247102003545,362.1325568119064],[383.78098522126675,364.52121391519904],[407.6675565233454,372.88151391316205],[435.1371135208756,391.99077091459185],[454.84353492129594,414.0858494127169],[467.9811491211876,454.6930207135156],[471.56413482129574,480.96824921295047],[462.00950632151216,514.4094490176067],[447.08039922174066,538.8931846134365],[421.40233502164483,563.376920312643],[396.32143512088805,569.9457274125889],[364.67172812111676,573.5287131108344],[330.03619972243905,569.3485631113872]];
    const wazerSmilePoints = [[-206.2173267789185,241.50537151284516],[-163.22149837762117,225.38193590939045],[-148.8895555799827,187.16342171654105],[-143.51507707778364,166.2626718133688],[-131.5717913787812,131.0299791144207],[-115.44835577905178,108.93490061443299],[-87.97879867907614,76.09086501784623],[-57.523420279845595,51.60712941177189],[-21.096398978494108,27.123393811285496],[42.20301512256265,5.625479617156088],[104.30810052156448,-1.5404917877167463],[167.01035032328218,0.8481653109192848],[230.3097643200308,19.95742241293192],[289.4290284207091,45.03832231462002],[336.6050068223849,89.82564350776374],[374.226356619969,141.18177191819996],[395.7242708206177,196.71805031318218],[417.81934932246804,215.23014311213046],[444.0945778209716,217.6188002107665],[472.7584634227678,210.4528288114816],[491.2705562207848,194.92655741237104],[497.8393633207306,173.42864320985973],[496.04787042178214,134.01580051518977],[490.07622762117535,114.30937921069562],[454.24637062009424,53.99578651320189],[412.44487082213163,3.833986713550985],[367.06038522161543,-37.96751308441162],[313.9127640221268,-69.02005578670651],[246.4332000212744,-91.71229858975857],[183.73095022141933,-103.6555842878297],[124.61168622225523,-110.22439138777554],[61.90943642240018,-109.6272270893678],[-4.375798978842795,-98.2811056887731],[-67.07804877776653,-72.00587728898972],[-121.41999857779592,-37.96751308441162],[-169.79030547756702,2.639658212661743],[-208.00881967972964,52.20429371111095],[-237.26986957900226,108.33773631323129],[-258.7677837777883,174.02580751106143],[-251.60181237850338,212.24432161357254],[-236.0755409784615,230.75641441345215]];*/
    const wazerMainPoints = [[-825.626518426463,108.92926579900086],[-813.6832328271121,261.8033223003149],[-787.4080043267459,510.22366420179605],[-720.5256046261638,686.984292101115],[-608.2587193250656,849.4129771981388],[-450.60734852589667,985.5664338013157],[-290.56732052750885,1076.3354048961774],[-46.92429292574525,1152.7724331999198],[172.83216337487102,1169.4930330999196],[394.9772767741233,1133.6631761016324],[574.1265617739409,1076.3354048961774],[762.8304753750563,947.347919696942],[958.7003602739424,744.3120633009821],[1039.914702873677,569.9400926018134],[1087.687845574692,414.6773789068684],[1092.4651597738266,221.1961511010304],[1051.8579884748906,30.103580403141677],[937.2024460732937,-192.0415329998359],[769.9964467734098,-359.24753239937127],[566.3634261749685,-476.88889610022306],[523.9314865749329,-495.24297410435975],[465.40938657335937,-519.1295454027131],[406.88728697411716,-534.6558167971671],[335.22757297568023,-547.7934309970587],[249.23591617494822,-553.7650738982484],[163.27753487415612,-557.5060744965449],[-259.5147778261453,-552.7287601968274],[-312.363816825673,-486.7444393970072],[-394.77248792536557,-428.22233960032463],[-452.10025912337005,-417.47338250279427],[-532.1202731262892,-416.279054004699],[-599.002672823146,-438.97129670344293],[-668.2737297285348,-481.96712509635836],[-747.0994151253253,-609.7602817993611],[-754.2653865255415,-687.3916386011988],[-739.9334437251091,-776.966281099245],[-696.9376153256744,-845.0430093985051],[-637.9721384253353,-898.2501378972083],[-547.8003316260874,-934.6771591976285],[-478.5292747244239,-940.0516377994791],[-402.68941072560847,-924.5253663919866],[-331.62686102464795,-885.7096879947931],[-265.9387898258865,-812.855645397678],[-242.0522185266018,-751.3477242002264],[-235.62820652499795,-693.6595310987905],[141.77962067350745,-691.2708738045767],[148.34842777438462,-745.6128235943615],[168.65201337449253,-804.7320876931772],[224.18829177506268,-874.6003088001162],[299.4309914726764,-924.1649442994967],[400.35175537504256,-940.288379999809],[492.9122192747891,-924.1649442994967],[568.1549189724028,-879.9747873991728],[629.0656758733094,-811.3008947996423],[660.7153829764575,-725.9064021995291],[660.7153829764575,-645.8863882990554],[646.3834400735795,-583.7813027957454],[824.9355608746409,-478.68038909882307],[951.5343888737261,-364.0248466953635],[1054.2466456741095,-251.75796139240265],[1123.5177025739104,-122.7704761987552],[1197.5660736747086,68.3220945019275],[1223.8413021750748,242.6940652988851],[1219.0639878734946,438.5639502014965],[1180.8454737737775,586.6606925027445],[1085.2991883736104,804.0284917028621],[941.9797603748739,961.6798625066876],[815.3809322733432,1083.5013763038442],[664.8955328743905,1169.4930330999196],[478.58027647435665,1248.3187185013667],[289.87636287510395,1286.5372326010838],[134.61364927329123,1296.0918611995876],[-27.81503582559526,1286.5372326010838],[-185.46640662662685,1253.0960328010842],[-307.2879205234349,1202.9342330014333],[-462.55063412711024,1119.331233303994],[-603.4814050253481,1023.7849480006844],[-708.5823189262301,921.072691200301],[-794.5739757250994,811.1944630956277],[-866.233689725399,672.6523493025452],[-911.6181753259152,522.1669499026611],[-933.1160895265639,386.0134933060035],[-953.7182572241873,140.27805820014328],[-978.7991571258754,51.89774420205504],[-1021.79498552531,-6.624355601146817],[-1051.6531997267157,-28.122269799932837],[-1086.2887281253934,-35.28824120294303],[-1143.6164993252605,-35.28824120294303],[-1194.9726277254522,-55.591826799325645],[-1236.7741275262088,-95.00466950144619],[-1253.4947274252772,-142.7778121996671],[-1253.4947274252772,-197.71692620031536],[-1227.2194990254939,-255.04469739831984],[-1167.5030706264079,-329.0930685997009],[-1040.90424262546,-436.58263960201293],[-911.9167573284358,-522.574296399951],[-742.3221009261906,-596.6226676004007],[-671.856715425849,-483.1614536959678],[-851.0060004256666,-407.9187539992854],[-987.1594570279121,-318.34411150496453],[-1085.0943995267153,-221.60349759459496],[-1130.4788851253688,-165.47005490213633],[-1055.2361854258925,-164.2757263975218],[-979.9934856258333,-139.19482649862766],[-927.4430287256837,-96.19899809546769],[-855.7833147253841,4.124601501971483]];
    const wazerLEyePoints = [[-148.03461312502623,644.3344240998849],[-204.16805572621524,635.9741241019219],[-259.1071698255837,591.7839671028778],[-275.8277697265148,545.2051529996097],[-275.8277697265148,497.43201029952615],[-256.718512725085,448.46453910227865],[-224.47164142504334,410.24602500442415],[-181.47581302560866,394.719753597863],[-131.31401322595775,392.33109650202096],[-95.48415622673929,405.4687107009813],[-59.65429922565818,436.52125339768827],[-32.184742126613855,474.7397675970569],[-28.601756425574422,528.4845530986786],[-38.15638502500951,576.2576958006248],[-66.8202706258744,615.6705384999514],[-105.03878472559154,638.362781200558]];
    const wazerREyePoints = [[445.5466845743358,661.0550239980221],[389.4132419731468,652.6947239981964],[346.4174134749919,622.8365099001676],[318.9478564746678,575.063367200084],[317.75352787412703,535.6505244988948],[320.1421850733459,509.37529599666595],[338.0571135748178,469.962453299202],[360.7493562735617,440.1042390950024],[407.3281704746187,413.8290107017383],[450.32399887405336,409.0516964001581],[501.6801271736622,423.3836391996592],[536.3156556747854,453.24185340013355],[563.7852126751095,498.62633889820427],[570.9511840734631,553.5654530003667],[555.4249126743525,603.7272528009489],[501.6801271736622,652.6947239981964]];
    const wazerSmilePoints = [[-229.2489556260407,266.92659699730575],[-261.4958269260824,259.7606255989522],[-286.57672692649066,237.06838279496878],[-296.1313554253429,203.6271829046309],[-292.54836972616613,174.9632973028347],[-269.8561269249767,102.10925470199436],[-214.91701282560825,8.951626505702734],[-148.03461312502623,-51.959130394272506],[-62.042956326156855,-108.09257299825549],[25.143029073253274,-134.36780149769038],[108.74602877348661,-151.0884013948962],[168.46245707385242,-147.5054156994447],[246.09381387382746,-140.33944429829717],[352.3890563733876,-111.67555869650096],[428.8260846734047,-73.45704459864646],[512.4290842749178,-2.991659101098776],[560.2022269740701,60.30775489844382],[596.0320839732885,130.77314030285925],[604.3923839740455,183.32359729986638],[594.8377553746104,214.3761400040239],[568.562526974827,234.67972560133785],[537.5099841747433,241.84569700062275],[504.0687843747437,232.29106849897653],[482.57087017409503,216.76479709986597],[470.62758447416127,178.5462829992175],[447.9353416748345,130.77314030285925],[396.579213373363,68.6680548992008],[347.61174207367003,30.44954070355743],[295.06128517352045,7.757298002950847],[197.1263426747173,-23.29524479713291],[101.58005737327039,-23.29524479713291],[16.782729076221585,-1.7973305964842439],[-56.07131352648139,38.8098406996578],[-114.59341322630644,96.13761190045625],[-148.03461312502623,146.29941170383245],[-164.75521302595735,201.23852579668164],[-171.92118442431092,239.45703989826143],[-195.8077558260411,259.7606255989522]];

    let center;
    function bootstrap(tries=1) {
        if (W && W.map && W.model && W.loginManager.user && $ && WazeWrap.Ready)
        {
            init();
        }
        else if (tries < 1000)
        {
            setTimeout(function () {bootstrap(++tries);}, 200);
        }
    }

    bootstrap();

    function init(){
        var $section = $("<div>");
        $section.html([
            '<div>',
            '<button id="wazerCreatorSetCenter" class="wazerCreatorSetCenterButton" type="button">Set Center for Wazer</button>',
            '<div id="wazerCreatorCenterDiv" class="wazerCreatorCenterDiv">Center: Unset</div>',
            '<button id="wazerCreatorCreateBody" class="wazerCreatorCreateBodyButton" type="button" disabled>Create Wazer body</button>',
            '<button id="wazerCreatorCreateLEye" class="wazerCreatorCreateLEyeButton" type="button" disabled>Create left Wazer eye</button>',
            '<button id="wazerCreatorCreateREye" class="wazerCreatorCreateREyeButton" type="button" disabled>Create right Wazer eye</button>',
            '<button id="wazerCreatorCreateSmile" class="wazerCreatorCreateSmileButton" type="button" disabled>Create Wazer smile</button>',
            '</div>'
        ].join(' '));

        new WazeWrap.Interface.Tab('Wazer Creater', $section.html(), initializeSettings);

        $('.wazerCreatorSetCenterButton').on('click', setCenter);
        $('.wazerCreatorCreateBodyButton').on('click', createWazerBody);
        $('.wazerCreatorCreateLEyeButton').on('click', createWazerLEye);
        $('.wazerCreatorCreateREyeButton').on('click', createWazerREye);
        $('.wazerCreatorCreateSmileButton').on('click', createWazerSmile);

        console.log("WME Wazer Creater " + GM_info.script.version);
    }

    function initializeSettings() { }

    function setCenter()
    {
        if (WazeWrap.hasMapCommentSelected())
        {
            let mapComment = WazeWrap.getSelectedFeatures()[0];
            let model = mapComment.model;
            center = model.geometry.getCentroid();
            $('.wazerCreatorCenterDiv').text(`Center: ${center.x}, ${center.y}`);
            $('.wazerCreatorCreateBodyButton').removeAttr("disabled");
            $('.wazerCreatorCreateLEyeButton').removeAttr("disabled");
            $('.wazerCreatorCreateREyeButton').removeAttr("disabled");
            $('.wazerCreatorCreateSmileButton').removeAttr("disabled");
        }
    }

    function updateCommentForWazer(points){
        if (WazeWrap.hasMapCommentSelected())
        {
            var mapComment = WazeWrap.getSelectedFeatures()[0];
            let model = mapComment.model;
            getPointsArray(model.geometry)
            let newerGeo = getWazerWKT(points);
            let UO = require("Waze/Action/UpdateObject");
            W.model.actionManager.add(new UO(model, { geometry: newerGeo }));
        }
    }

    function getPointsArray(geometry){
        let vertices = geometry.getVertices();
        let str = '[';
        for(let x = 0; x < vertices.length; x++)
        {
            str += `[${vertices[x].x-center.x},${vertices[x].y-center.y}],`;
        }
        str = str.slice(0, -1);
        str += ']';
        console.log(str);
    }

    function createWazerBody(){ updateCommentForWazer(wazerMainPoints); }
    function createWazerLEye(){ updateCommentForWazer(wazerLEyePoints); }
    function createWazerREye(){ updateCommentForWazer(wazerREyePoints); }
    function createWazerSmile(){ updateCommentForWazer(wazerSmilePoints); }

    function getWazerWKT(points){
        let wktText = 'POLYGON((';
        for (let i=0; i < points.length; i++){
            wktText += `${center.x + points[i][0]} ${center.y + points[i][1]},`;
        }
        wktText = wktText.slice(0, -1)
        wktText += '))';
        console.log(wktText);
        return OpenLayers.Geometry.fromWKT(wktText);
    }
})();
